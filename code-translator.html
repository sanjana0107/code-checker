<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writio Code Translator</title>
    <link rel="icon" href="images/writio(wh-bg).png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Honk&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/editor/editor.main.css">
    <link rel="stylesheet" href="css/loader.css">
</head>
<body>
    <div class="loader" id="loader">
        <div style="--i: 1"></div>
        <div style="--i: 2"></div>
        <div style="--i: 3"></div>
        <div style="--i: 4"></div>
    </div>
    <div class="video-container">
        <video autoplay muted loop id="myVideo">
            <source src="videos/bg3.mp4" type="video/mp4">
        </video>
        <div class="video-overlay"></div>
    </div>
    
    <div class="content-container">
        <h1 id="homepage" class="cyberpunk-glitched-header">WRITIO</h1>
        <h1 class="cyberpunk glitched">CODE TRANSLATOR</h1>
        <h3 class="cyberpunk glitched">Enter your code:</h3>
        <div id="editor-container" style="height: 200px; width: auto; border: 1px solid #ccc;"></div>
        <button id="clear_input_btn" class="cyberpunk2077 green">Clear</button><br>
        
        <h3 class="cyberpunk glitched">Target Language:</h3>
        <div class="cyber-select" id="target_select">
            <button class="cyber-select__trigger" type="button" aria-haspopup="listbox" aria-expanded="false">Python</button>
            <ul class="cyber-select__menu" role="listbox"></ul>
        </div>
        <select id="target_lang" class="cyberpunk dropdown" style="position:absolute; opacity:0; pointer-events:none; height:0; width:0;">
            <option value="python">Python</option>
            <option value="java">Java</option>
            <option value="JavaScript">JavaScript</option>
            <option value="csharp">C#</option>
            <option value="cpp">C++</option>
            <option value="ruby">Ruby</option>
            <option value="go">Go</option>
            <option value="php">PHP</option>
            <option value="swift">Swift</option>
            <option value="rust">Rust</option>
            <option value="kotlin">Kotlin</option>
            <option value="typescript">TypeScript</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="sql">SQL</option>
            <option value="bash">Bash</option>
            <option value="perl">Perl</option>
            <option value="scala">Scala</option>
        </select>
        
        <button id="check_btn" class="cyberpunk2077 red">Translate</button>
        <br>
        <h3 class="cyberpunk glitched">Translated Code:</h3>
        <div id="output-container" style="height: 300px; width: auto; border: 1px solid #ccc;"></div>
        <button id="clear_output_btn" class="cyberpunk2077 green">Clear</button>
        <button id="copy_output_btn" class="cyberpunk2077 purple">Copy</button>
    </div>
    <footer>
        <h2 class="cyberpunk glitched">Made by <span class="name">Sanjana</span></h2>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.min.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            async function serverGenerate(textPrompt) {
                const resp = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: textPrompt })
                });
                if (!resp.ok) {
                    const err = await resp.text();
                    throw new Error(`Server error ${resp.status}: ${err}`);
                }
                const data = await resp.json();
                return data.text || '';
            }
            var codeEditor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '// Your code goes here...\n',
                language: 'plaintext',
                theme: 'vs-dark',
                automaticLayout: true,
                readOnly: false
            });

            var outputEditor = monaco.editor.create(document.getElementById('output-container'), {
                value: '// Translated Code:\n',
                language: 'plaintext',
                theme: 'vs-dark',
                automaticLayout: true,
                readOnly: true
            });

            function initCyberSelect() {
                const native = document.getElementById('target_lang');
                const container = document.getElementById('target_select');
                const trigger = container.querySelector('.cyber-select__trigger');
                const menu = container.querySelector('.cyber-select__menu');

                // Build menu from native options
                menu.innerHTML = '';
                Array.from(native.options).forEach((opt, idx) => {
                    const li = document.createElement('li');
                    li.className = 'cyber-select__option';
                    li.setAttribute('role', 'option');
                    li.dataset.value = opt.value;
                    li.textContent = opt.textContent;
                    if (idx === native.selectedIndex) li.setAttribute('aria-selected', 'true');
                    li.addEventListener('click', () => {
                        native.value = opt.value;
                        trigger.textContent = opt.textContent;
                        menu.querySelectorAll('.cyber-select__option').forEach(el => el.removeAttribute('aria-selected'));
                        li.setAttribute('aria-selected', 'true');
                        container.classList.remove('open');
                        trigger.setAttribute('aria-expanded', 'false');
                    });
                    menu.appendChild(li);
                });

                function toggle() {
                    const open = container.classList.toggle('open');
                    trigger.setAttribute('aria-expanded', open ? 'true' : 'false');
                }

                trigger.addEventListener('click', toggle);
                document.addEventListener('click', (e) => {
                    if (!container.contains(e.target)) {
                        container.classList.remove('open');
                        trigger.setAttribute('aria-expanded', 'false');
                    }
                });

                // Initialize trigger text
                trigger.textContent = native.options[native.selectedIndex].textContent;
            }

            initCyberSelect();

            document.getElementById('check_btn').addEventListener('click', async function() {
                document.getElementById('loader').style.display = 'flex';
                const sourceCode = codeEditor.getValue().trim();
                const targetLanguage = document.getElementById('target_lang').value;
                if (!sourceCode) {
                    alert('Please fill in the Code field.');
                    document.getElementById('loader').style.display = 'none';
                    return;
                }
                try {
                    const modifiedPrompt = `Translate the following code from the source language to ${targetLanguage}:\n\n${sourceCode}`;
                    let text = '';
                    try {
                        text = await serverGenerate(modifiedPrompt);
                    } catch (serverErr) {
                        const fromStorage = localStorage.getItem('GEMINI_API_KEY');
                        if (!fromStorage) throw serverErr;
                        const genAI = new GoogleGenerativeAI(fromStorage.trim());
                        const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
                        const result = await model.generateContent(modifiedPrompt);
                        const resp = await result.response;
                        text = await resp.text();
                    }
                    const outputIndex = text.indexOf('Output:');
                    const translatedCode = outputIndex !== -1 ? text.substring(0, outputIndex).trim() : text.trim();
                    outputEditor.setValue(translatedCode);
                } catch (error) {
                    console.error('Error:', error);
                    alert('Gemini error: ' + (error && error.message ? error.message : error));
                } finally {
                    document.getElementById('loader').style.display = 'none';
                }
            });

            document.getElementById('clear_input_btn').addEventListener('click', function() {
                codeEditor.setValue('\n');
            });

            document.getElementById('clear_output_btn').addEventListener('click', function() {
                outputEditor.setValue('\n');
            });

            document.getElementById('copy_output_btn').addEventListener('click', function() {
                const text = outputEditor.getValue();
                navigator.clipboard.writeText(text);
            });

            document.getElementById('homepage').addEventListener('click', function() {
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>